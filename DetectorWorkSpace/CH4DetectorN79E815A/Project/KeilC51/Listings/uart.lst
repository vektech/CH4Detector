C51 COMPILER V9.60.0.0   UART                                                              02/01/2020 20:45:29 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN .\Objects\uart.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil\C51\BIN\C51.EXE ..\..\Code\Source\uart.c LARGE OPTIMIZE(8,SPEED) BROWSE
                    - INCDIR(..\..\Code\Include) DEBUG OBJECTEXTEND PRINT(.\Listings\uart.lst) TABS(2) OBJECT(.\Objects\uart.obj)

line level    source

   1          /**
   2           *******************************************************************************
   3           * @copyright 2017-2020, Electronic Technology Co. Ltd
   4           * @file      uart.c
   5           * @version   V1.0.0
   6           * @brief     
   7           * @warning   
   8           *******************************************************************************
   9           * @remarks
  10           * 1. Version                Date                 Author
  11           *    v1.0.0                 2020Äê1ÔÂ1ÈÕ          Unknown
  12           *    Modification: ´´½¨ÎÄµµ
  13           *******************************************************************************
  14           */
  15          /* NEED FIX */
  16          /*******************************************************************************
  17           *                 Include File Section ('#include')
  18           ******************************************************************************/
  19          #include "N79E81x.h"
  20          #include "GlobalAppDefine.h"
  21          #include "uart.h"
  22          #include "delay.h"
  23          
  24          /*******************************************************************************
  25           *                 Macro Define Section ('#define')
  26           ******************************************************************************/
  27          
  28          /*******************************************************************************
  29           *                 Struct Define Section ('typedef')
  30           ******************************************************************************/
  31          
  32          /*******************************************************************************
  33           *                 File Static Prototype Declare Section ('static function')
  34           ******************************************************************************/
  35          
  36          /*******************************************************************************
  37           *                 Global Variable Declare Section ('variable')
  38           ******************************************************************************/
  39          uint8_t uart_buffer[20] = {0x00};
  40          uint8_t rx_index;
  41          uint8_t rx_finished;
  42          
  43          /* ÓÃÓÚÔÚ Timer2 ÖÐ¼ì²é´®¿Ú½ÓÊÜ³¬Ê± Ã¿´Î½ÓÊÕÇåÁã Á½´Î Timer2 ÖÐ¶Ïºó¼ì²é½ÓÊÕµÄ½á¹û */
  44          uint8_t rx_count;
  45          
  46          /*******************************************************************************
  47           *                 File Static Variable Define Section ('static variable')
  48           ******************************************************************************/
  49          
  50          /*******************************************************************************
  51           *                 Normal Function Define Section ('function')
  52           ******************************************************************************/
  53          /* ---- Use timer1 as baudrate generator ---- */
  54          void uart_init(uint32_t bandrate)
C51 COMPILER V9.60.0.0   UART                                                              02/01/2020 20:45:29 PAGE 2   

  55          {
  56   1          /* SCON = 11010010B ´®¿Ú¿ØÖÆ
  57   1              - SM0/SM1[7:6] = 11B: Mode3 Òì²½11Î»Ö¡³¤¶È ¶¨Ê±Æ÷1Òç³öÊ±¼ä ³ýÒÔ32»ò³ýÒÔ16 
  58   1              - SM2[5]       = 0B:  ½ÓÊÕÓÐÐ§, ÎÞÂÛµÚ9Î»ÊÇ·ñÓÐÂß¼­µçÆ½
  59   1              - REN[4]       = 1B:  ´ò¿ª´®¿ÚµÄ½ÓÊÕ¹¦ÄÜ,½ÓÊÕÍê³ÉºóÐèÈí¼þÇå³ý¸ÃÎ»
  60   1              - TB8[3]       = 0B:  Mode2ºÍMode3ÖÐÒª±»·¢ËÍµÄµÚ¾ÅÎ»Êý¾Ý
  61   1              - RB8[2]       = 0B:  Mode2ºÍMode3ÖÐÒª½ÓÊÕµ½µÄµÚ¾ÅÎ»Êý¾Ý
  62   1              - TI[1]        = 1B:  ·¢ËÍÖÐ¶Ï±êÖ¾Î», ³ýMode0Íâ, ÔÚ´®¿Ú·¢ËÍµ½Í£Ö¹Î»Ê±ÖÃÎ», ¸ÃÎ»±ØÐëÓÉÈí¼þÀ´Çå³ý
  63   1              - RI[0]        = 0B:  ½ÓÊÕÖÐ¶Ï±êÖ¾, Mode2ºÍMode3ÏÂ, ½ÓÊÕµ½µÚ¾ÅÎ»Ê±ÖÃÎ», ¸ÃÎ»±ØÐëÓÉÈí¼þÀ´Çå³ý
  64   1              */
  65   1          SCON = 0xD2;
  66   1      
  67   1          /* PCON = 0000 0000B µçÔ´¿ØÖÆ
  68   1              - SMOD[7]  = 0 ¹Ø±Õ²¨ÌØÂÊ¼Ó±¶ ÔÚÄ£Ê½1,2»ò3ÖÐ´®¿Ú²¨ÌØÂÊ¼Ó±¶Ê¹ÄÜÎ» ½öÊÊÓÃÓÚ¶¨Ê±Æ÷1Òç³ö×÷ÎªÎª²¨ÌØÂÊÊ±
             -ÖÓÔ´Ê±
  69   1              - SMOD0[6] = 0 ¹Ø±ÕÖ¡´íÎó¼ì²â¹¦ÄÜ
  70   1              - POF[4]   = 0 ÉÏµç¸´Î»ºó¸ÃÎ»ÖÃ1 ±íÊ¾Ò»´ÎÀä¸´Î» ÉÏµç¸´Î»Íê³É ÔÚÆäËû¸´Î»ºó¸ÃÎ»±£³Ö²»±ä ½¨ÒéÈí¼þÇå¸Ã
             -±êÖ¾
  71   1              - GF1[3]   = 0 Í¨ÓÃ±êÖ¾1 Í¨ÓÃ±êÖ¾¿ÉÓÉÓÃ»§ÖÃÎ»»òÇåÁã
  72   1              - GF0[2]   = 0 Í¨ÓÃ±êÖ¾0 Í¨ÓÃ±êÖ¾¿ÉÓÉÓÃ»§ÖÃÎ»»òÇåÁã
  73   1              - PD[1]    = 0 ÉèÖÃ¸ÃÎ»Ê¹MCU½øÈëµôµçÄ£Ê½ ÔÚ´ËÄ£Ê½ÏÂ CPUºÍÍâÉèÊ±ÖÓÍ£Ö¹ ³ÌÐò¼ÆÊýÆ÷PC¹ÒÆð ´ËÊ±Îª×îÐ¡¹
             -¦ºÄ
  74   1              - IDL[0]   = 0 ÉèÖÃ¸ÃÎ»Ê¹MCU½øÈë¿ÕÏÐÄ£Ê½ ÔÚ´ËÄ£Ê½ÏÂ CPUÊ±ÖÓÍ£Ö¹ ÇÒ³ÌÐò¼ÆÊýÆ÷PC¹ÒÆð
  75   1              */
  76   1          PCON = 0x00;
  77   1      
  78   1          /* TMOD = 0010 0000B ¶¨Ê±Æ÷0ºÍ1Ä£Ê½ÅäÖÃ 
  79   1              - [7]   = 0B  ¶¨Ê±Æ÷1 ÃÅ¿ØÖÆ µ±TR1=1Ê± ¶¨Ê±Æ÷1 Ê±ÖÓÔËÐÐ²»¹Ü~INT1µÄÂß¼­µçÆ½
  80   1              - [6]   = 0B  ¶¨Ê±Æ÷1 ¼ÆÊýÆ÷/¶¨Ê±Æ÷Ñ¡Ôñ ¶¨Ê±Æ÷1ËæÄÚ²¿Ê±ÖÓ¶øµÝÔö
  81   1              - [5:4] = 10B Ä£Ê½2: 8Î»¶¨Ê±Æ÷/¼ÆÊýÆ÷´ø×Ô¶¯´ÓTH1ÖØÔØÄ£Ê½
  82   1              - [3]   = 0B  ¶¨Ê±Æ÷0 ÃÅ¿ØÖÆ µ±TR0=1Ê± ¶¨Ê±Æ÷0 Ê±ÖÓÔËÐÐ²»¹Ü~INT0µÄÂß¼­µçÆ½
  83   1              - [2]   = 0B  ¶¨Ê±Æ÷0 ¼ÆÊýÆ÷/¶¨Ê±Æ÷Ñ¡Ôñ ¶¨Ê±Æ÷0ËæÄÚ²¿Ê±ÖÓ¶øµÝÔö
  84   1              - [1:0] = 00B Ä£Ê½0: 8Î»¶¨Ê±Æ÷/¼ÆÊýÆ÷´ø5Î»Ô¤·ÖÆµ TL1[4:0]
  85   1              */
  86   1          TMOD = 0x20;
  87   1      
  88   1      #ifdef FOSC_110592
                  TH1 = 256 - (28800 / bandrate); /* 11.059M/384=28800 */
              #endif
  91   1      #ifdef FOSC_184320
                  TH1 = 256 - (48000 / bandrate); /* 18.4320M/384=48000 */
              #endif
  94   1          /* Ê¹ÓÃ¸ÃÅäÖÃ ÔÚ¿ÉIDEÖÐ½øÐÐ¶¨Òå¡¡FOSC_221184 */
  95   1      #ifdef FOSC_221184
  96   1          TH1 = 256 - (57600 / bandrate); /* 22.1184M/384=57600 */
  97   1      #endif
  98   1      #ifdef FOSC_331776
                  TH1 = 256 - (86400 / bandrate); /* 33.1776M/384=86400 */
              #endif
 101   1      #ifdef FOSC_368640
                  TH1 = 256 - (96000 / bandrate); /* 36.8640M/384=96000 */
              #endif
 104   1          /* ¿ªÆô¶¨Ê±Æ÷1 */
 105   1          TR1 = 1;
 106   1      }
 107          
 108          void uart_send(uint8_t byte)
 109          {
 110   1          /* ÆæÅ¼Ð£Ñé 0 = Å¼Ð£Ñé, 1 = ÆæÐ£Ñé */
 111   1      #if (UART_PARITY_SET == EVEN_PARITY)
 112   1          /* ½«·¢ËÍµÄÊý¾Ý·ÅÖÁACCÖÐ */
 113   1          /* PSW ÖÐµÄ PÎ» ÎªÆæÅ¼±êÖ¾ ÀÛ¼Ó½á¹ûÎªÆæÊýÊ±Îª1 Å¼ÊýÊ±Îª0 */
C51 COMPILER V9.60.0.0   UART                                                              02/01/2020 20:45:29 PAGE 3   

 114   1          ACC = byte;
 115   1          /* Å¼Ð£Ñé TB8 ´æ´¢Òª·¢ËÍµÄÐ£ÑéÎ» */
 116   1          TB8 = P;
 117   1      #else
                  /* ½«·¢ËÍµÄÊý¾Ý·ÅÖÁACCÖÐ */
                  /* PSW ÖÐµÄ PÎ» ÎªÆæÅ¼±êÖ¾ ÀÛ¼Ó½á¹ûÎªÆæÊýÊ±Îª1 Å¼ÊýÊ±Îª0 */
                  ACC = byte;
                  /* ÆæÐ£Ñé TB8 ´æ´¢Òª·¢ËÍµÄÐ£ÑéÎ» */
                  TB8 = ~P;
              #endif
 124   1          /* SBUF ´®ÐÐ¿Ú½ÓÊÕ»òÕß·¢ËÍµÄÊý¾Ý¶¼·ÅÔÚÕâ¸ö¼Ä´æÆ÷ÖÐ
 125   1              - Êµ¼ÊÉÏ¸ÄµØÖ·ÉÏÓÐ2¸ö¶ÀÁ¢µÄ8Î»¼Ä´æÆ÷ Ò»¸öÓÃÓÚ½ÓÊÕÊý¾Ý Ò»¸öÓÃÓÚ·¢ËÍÊý¾Ý
 126   1              - ¶ÔËü½øÐÐ¶Á²Ù×÷½«»á½ÓÊÕ´®ÐÐÊý¾Ý ¶ÔËü½øÐÐÐ´²Ù×÷Ôò·¢ËÍ´®ÐÐÊý¾Ý 
 127   1              - Ã¿´ÎÏòSBUFÐ´ÈëÒ»×Ö½ÚÊý¾Ý Æô¶¯Ò»´Î·¢ËÍ 
 128   1              */
 129   1          SBUF = byte;
 130   1      }
 131          
 132          /* UART ÖÐ¶Ï·þÎñº¯Êý */
 133          void UART_ISR(void) interrupt 4
 134          {
 135   1          uint8_t i = 0;
 136   1          bit parity_bit = 0;
 137   1      
 138   1          /* ¶Á¹ý³Ì RI ¼´ Reception Interrupt Flag */
 139   1          if (RI == 1)
 140   1          {
 141   2              /* Clear reception flag for next reception */
 142   2              RI = 0;
 143   2      
 144   2              /* SBUF ´®ÐÐ¿Ú½ÓÊÕ»òÕß·¢ËÍµÄÊý¾Ý¶¼·ÅÔÚÕâ¸ö¼Ä´æÆ÷ÖÐ
 145   2                  - Êµ¼ÊÉÏ¸ÄµØÖ·ÉÏÓÐ2¸ö¶ÀÁ¢µÄ8Î»¼Ä´æÆ÷ Ò»¸öÓÃÓÚ½ÓÊÕÊý¾Ý Ò»¸öÓÃÓÚ·¢ËÍÊý¾Ý
 146   2                  - ¶ÔËü½øÐÐ¶Á²Ù×÷½«»á½ÓÊÕ´®ÐÐÊý¾Ý ¶ÔËü½øÐÐÐ´²Ù×÷Ôò·¢ËÍ´®ÐÐÊý¾Ý 
 147   2                  - Ã¿´ÎÏòSBUFÐ´ÈëÒ»×Ö½ÚÊý¾Ý Æô¶¯Ò»´Î·¢ËÍ 
 148   2                  */
 149   2              ACC = SBUF;
 150   2      
 151   2              /* PSW ÖÐµÄ PÎ» ÎªÆæÅ¼±êÖ¾ ÀÛ¼Ó½á¹ûÎªÆæÊýÊ±Îª1 Å¼ÊýÊ±Îª0 */
 152   2              if (P)
 153   2              {
 154   3                  /* ÎªÆæÊýÊ±ÖÃ1 */
 155   3                  parity_bit = 1;
 156   3              }
 157   2      
 158   2          /* ÆæÅ¼Ð£Ñé 0=Å¼Ð£Ñé 1=ÆæÐ£Ñé */
 159   2      #if (UART_PARITY_SET == EVEN_PARITY)
 160   2              /* Å¼Ð£Ñé */
 161   2              if (RB8 == (parity_bit))
 162   2              {
 163   3                  /* ¶ÁSBUF ´æÈërxbufÖÐ */
 164   3                  uart_buffer[rx_index++] = SBUF;
 165   3                  /* Rx ´æ´¢¿Õ¼ä½«Âú */
 166   3                  if (rx_index >= (sizeof(uart_buffer) - 1))
 167   3                  {
 168   4                      /* UART0 ¹Ø±Õ½ÓÊÕ¹¦ÄÜ */
 169   4                      UART0_RX_DISABLE;
 170   4                      /* ½ÓÊÕÍê³É */
 171   4                      rx_finished = 1;
 172   4                  }
 173   3              }
 174   2      #else
                      /* ÆæÐ£Ñé */
C51 COMPILER V9.60.0.0   UART                                                              02/01/2020 20:45:29 PAGE 4   

                      if (RB8 == (~parity_bit))
                      {
                          /* ¶ÁSBUF ´æÈërxbufÖÐ */
                          uart_buffer[rx_index++] = SBUF;
                          /* Rx ´æ´¢¿Õ¼äÂú XXX ÎªºÎºÍÇ°Ïî²»Í¬ */
                          if (rx_index >= sizeof(uart_buffer))
                          {
                              /* UART0 ¹Ø±Õ½ÓÊÕ¹¦ÄÜ */
                              UART0_RX_DISABLE;
                              /* ½ÓÊÕÍê³É */
                              rx_finished = 1;
                          }
                      }
              #endif
 190   2              /* ¶Á´®¿ÚÊý¾ÝÖ±µ½´æ´¢¿Õ¼ä½«ÂúÎªÖ¹ */
 191   2              rx_count = 0;
 192   2          }
 193   1          /* Ð´ÖÐ¶Ï ´Ë´¦Çå³ýÐ´ÖÐ¶Ï±êÖ¾ */
 194   1          else
 195   1          {
 196   2              /* Clear transmit flag for next transmition */
 197   2              TI = 0;
 198   2          }
 199   1          /* XXX Ê¹ÄÜTIME2¶¨Ê±Æ÷ ÒòÎªÔÚ·äÃùÆ÷ÏìÖ®Ç° °ÑTR2¹ØµôÁË ·äÃùÆ÷¶ÀÕ¼CPUÊ±¼ä 
 200   1             ËùÒÔÒ»µ©½ÓÊÕµ½Êý¾Ý Ôò°ÑTIME2´ò¿ªÒÔÔö¼Ó´®¿Ú½ÓÊÕÍê³ÉÅÐ¶ÏµÄÊµÊ±ÐÔ */
 201   1          TR2 = 1;
 202   1      }
 203          
 204          /*******************************************************************************
 205           *                 File Static Function Define Section ('static function')
 206           ******************************************************************************/
 207          
 208          /*******************************************************************************
 209           *                 End of File ('EOF')
 210           ******************************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    147    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     23       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
