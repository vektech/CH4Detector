C51 COMPILER V9.60.0.0   I2C                                                               02/01/2020 20:17:01 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Objects\i2c.obj
COMPILER INVOKED BY: D:\Program Files (x86)\Keil\C51\BIN\C51.EXE ..\..\Code\Source\i2c.c LARGE OPTIMIZE(8,SPEED) BROWSE 
                    -INCDIR(..\..\Code\Include) DEBUG OBJECTEXTEND PRINT(.\Listings\i2c.lst) TABS(2) OBJECT(.\Objects\i2c.obj)

line level    source

   1          /**
   2           *******************************************************************************
   3           * @copyright 2017-2020, Electronic Technology Co. Ltd
   4           * @file      i2c.c
   5           * @version   V1.0.0
   6           * @brief     I2C Function(Master)
   7           *            SCL => P1.2
   8           *            SDA => P1.3
   9           *            Output => P1.4 toggle when I2C function pass
  10           *            I2CEN = 1 enable I2C function
  11           *            I2C Frequency == Fosc/(I2CLK+1)
  12           *            Use external OSC Fosc = 11.0592MHz
  13           *  
  14           *            <o0.0..7> I2CLK<2-255>
  15           *            <o1.0..7> I2C Slave Address<160-175>
  16           *            <h> UART pin Select
  17           *            <o2.6> Uart pin
  18           *            <0=> Select P1.0, P1.1 as UART pin(default)
  19           *            <1=> Select P2.6, P2.7 as UART pin(28 pin only)
  20           *            </h>
  21           * @warning   
  22           *******************************************************************************
  23           * @remarks
  24           * 1. Version                Date                 Author
  25           *    v1.0.0                 2020Äê1ÔÂ1ÈÕ          
  26           *    Modification: ´´½¨ÎÄµµ
  27           *******************************************************************************
  28           */
  29          /* NEED FIX */
  30          /*******************************************************************************
  31           *                 Include File Section ('#include')
  32           ******************************************************************************/
  33          #include "N79E81x.h"
  34          #include "i2c.h"
  35          #include "delay.h"
  36          #include "utlities.h"
  37          
  38          /*******************************************************************************
  39           *                 Macro Define Section ('#define')
  40           ******************************************************************************/
  41          #define I2C_CLOCK 255
  42          
  43          /* 1:±íÊ¾Ê±ÖÓÐ¾Æ¬ÎªPCF8563 0£º±íÊ¾Ê±ÖÓÐ¾Æ¬ÎªRX8010SJ */
  44          #define PCF8563  0
  45          
  46          /*******************************************************************************
  47           *                 Struct Define Section ('typedef')
  48           ******************************************************************************/
  49          
  50          /*******************************************************************************
  51           *                 File Static Prototype Declare Section ('static function')
  52           ******************************************************************************/
  53          static void i2c_start(void);
  54          static void i2c_8563_address(uint8_t sub);
C51 COMPILER V9.60.0.0   I2C                                                               02/01/2020 20:17:01 PAGE 2   

  55          static void i2c_reapeat_start(void);
  56          static void i2c_read_data(uint8_t *temp, uint8_t u8_data);
  57          static void i2c_deal_time_code(void);
  58          static void i2c_stop(void);
  59          static void i2c_write_data(uint8_t *time, uint8_t length);
  60          
  61          
  62          /*******************************************************************************
  63           *                 Global Variable Declare Section ('variable')
  64           ******************************************************************************/
  65          /* Ãë--·ÖÖÓ--Ð¡Ê±--ÈÕ--ÐÇÆÚ--ÔÂ--Äê */
  66          uint8_t i2c_time_code[7] = {0x00};
  67          
  68          /*******************************************************************************
  69           *                 File Static Variable Define Section ('static variable')
  70           ******************************************************************************/
  71          
  72          /*******************************************************************************
  73           *                 Normal Function Define Section ('function')
  74           ******************************************************************************/
  75          void i2c_init(void)
  76          {
  77   1          /* I2C Ö÷»úÄ£Ê½ Ê±ÖÓÉèÖÃ f[I2C] = f[PHERI] / (1 + I2CLK) ´Ó»úÄ£Ê½¸Ã×Ö½ÚÎÞÐ§ ¿É×Ô¶¯Í¬²½ 400kps ÒÔÏÂµÄËÙ
             -ÂÊ */
  78   1          I2CLK = I2C_CLOCK;
  79   1          /* Ê¹ÄÜ I2C×ÜÏß */
  80   1          I2CEN = 1;
  81   1      }
  82          
  83          /* µ÷ÓÃÒ»´Î¶Áº¯Êý Ô¼ºÄÊ±500uS */
  84          void i2c_get_time(void)
  85          {
  86   1          uint8_t i = 0;
  87   1      
  88   1          i2c_start();
  89   1      #if PCF8563 == 1
                  /* 8563 ¶Á¡¢Ð´µØÖ· */
                  i2c_8563_address(0xA2);
                  i2c_8563_address(0x02);
              
                  /* I2C Í£Ö¹ºóÖØÆô */
                  i2c_reapeat_start();
                  
                  /* 8563 ¶Á¡¢Ð´µØÖ· */
                  i2c_8563_address(0xA3);
                  i2c_read_data(i2c_time_code, 7);
                  i2c_deal_time_code();
              #else
 102   1          /* 8563 ¶Á¡¢Ð´µØÖ· */
 103   1          i2c_8563_address(0x64);
 104   1          i2c_8563_address(0x10);
 105   1          
 106   1          /* I2C Í£Ö¹ºóÖØÆô */
 107   1          i2c_reapeat_start();
 108   1      
 109   1          /* 8563 ¶Á¡¢Ð´µØÖ· */
 110   1          i2c_8563_address(0x65);
 111   1          i2c_read_data(i2c_time_code, 7);
 112   1          i2c_time_code[3] += i2c_time_code[4];
 113   1          i2c_time_code[4] = i2c_time_code[3] - i2c_time_code[4];
 114   1          i2c_time_code[3] = i2c_time_code[3] - i2c_time_code[4];
 115   1          i2c_deal_time_code();
C51 COMPILER V9.60.0.0   I2C                                                               02/01/2020 20:17:01 PAGE 3   

 116   1      #endif
 117   1      
 118   1          for (i = 0; i < 7; i++)
 119   1          {
 120   2              i2c_time_code[i] = bcd2hex(i2c_time_code[i]);
 121   2          }
 122   1          i2c_stop();
 123   1      }
 124          
 125          void i2c_set_time(void)
 126          {
 127   1          uint8_t i = 0;
 128   1          
 129   1          i2c_start();
 130   1      #if PCF8563 == 1
                  /* 8563 ¶Á¡¢Ð´µØÖ· */
                  i2c_8563_address(0xA2);
                  i2c_8563_address(0x02);
              
                  /* 8563 Ð´ÈëÊ±¼äÊý¾Ý */
                  i2c_write_data(i2c_time_code, 7);
              #else
 138   1          /* 8563 ¶Á¡¢Ð´µØÖ· */
 139   1          i2c_8563_address(0x64);
 140   1          i2c_8563_address(0x10);
 141   1      
 142   1          i = i2c_time_code[3];
 143   1          i2c_time_code[3] = i2c_time_code[4];
 144   1          i2c_time_code[4] = i;
 145   1          /* 8563 Ð´ÈëÊ±¼äÊý¾Ý */
 146   1          i2c_write_data(i2c_time_code, 7);
 147   1          i = i2c_time_code[3];
 148   1          i2c_time_code[3] = i2c_time_code[4];
 149   1          i2c_time_code[4] = i;
 150   1      #endif
 151   1          i2c_stop();
 152   1      }
 153          
 154          void i2c_start_rtc(void)
 155          {
 156   1          i2c_start();
 157   1      #if PCF8563 == 1
                  /* 8563 ¶Á¡¢Ð´µØÖ· */
                  i2c_8563_address(0xA2);
                  i2c_8563_address(0x00);
              
                  i2c_time_code[0] = 0;
                  i2c_write_data(i2c_time_code, 1);
              #else
 165   1          /* 8563 ¶Á¡¢Ð´µØÖ· */
 166   1          i2c_8563_address(0x64);
 167   1          i2c_8563_address(0x1f);
 168   1      
 169   1          i2c_time_code[0] = 0;
 170   1          i2c_write_data(i2c_time_code, 1);
 171   1      #endif
 172   1          i2c_stop();
 173   1      }
 174          
 175          /*******************************************************************************
 176           *                 File Static Function Define Section ('static function')
 177           ******************************************************************************/
C51 COMPILER V9.60.0.0   I2C                                                               02/01/2020 20:17:01 PAGE 4   

 178          static void i2c_start(void)
 179          {
 180   1          uint8_t delay_count = 0;
 181   1      
 182   1          /* I2C Start±êÖ¾ Èô×ÜÏß¿ÕÏÐÔò²úÉúI2CÆðÊ¼ÐÅºÅ */
 183   1          STA = 1;
 184   1      
 185   1          /* ¼ì²â´®ÐÐÖÐ¶Ï±êÖ¾SIÊÇ·ñÖÃÎ» ÖÃÎ»ºóÌø³öÑ­»· Í¨¹ý²âÊÔµÃÖª µÈ´ýÊ±¼äÎªcnnt=0x0e */
 186   1          while (!(I2CON & SET_BIT3))
 187   1          {
 188   2              if (++delay_count > 250)
 189   2              {
 190   3                  break;
 191   3              }
 192   2          }
 193   1      
 194   1          /* I2C Start±êÖ¾ ÔÚ¼ì²âµ½ÆðÊ¼ÐÅºÅºóÓ¦ÊÖ¶¯ÇåÁã */
 195   1          STA = 0;
 196   1      }
 197          
 198          static void i2c_reapeat_start(void)
 199          {
 200   1          uint8_t delay_count = 0;
 201   1      
 202   1          /* I2C Start±êÖ¾ Èô×ÜÏß¿ÕÏÐÔò²úÉúI2CÆðÊ¼ÐÅºÅ */
 203   1          STA = 1;
 204   1          /* STOÖÃ1 ½«ÔÚ×ÜÏßÉÏÊä³öÍ£Ö¹ÐÅºÅ */
 205   1          STO = 1;
 206   1          /* ´®ÐÐÖÐ¶Ï±êÖ¾SIÇåÁã ´®ÐÐ´«ÊäÔÝÍ£ */
 207   1          SI = 0;
 208   1      
 209   1          /* ¼ì²â´®ÐÐÖÐ¶Ï±êÖ¾SIÊÇ·ñÖÃÎ» ÖÃÎ»ºóÌø³öÑ­»· Í¨¹ý²âÊÔµÃÖª µÈ´ýÊ±¼äÎªcnnt=0x0e */
 210   1          while (!(I2CON & SET_BIT3))
 211   1          {
 212   2              if (++delay_count > 250)
 213   2              {
 214   3                  break;
 215   3              }
 216   2          }
 217   1      
 218   1          /* I2C Start±êÖ¾ ÔÚ¼ì²âµ½ÆðÊ¼ÐÅºÅºóÓ¦ÊÖ¶¯ÇåÁã */
 219   1          STA = 0;
 220   1      }
 221          
 222          static void i2c_stop(void)
 223          {
 224   1          uint8_t delay_count = 0;
 225   1      
 226   1          /* STOÖÃ1 ½«ÔÚ×ÜÏßÉÏÊä³öÍ£Ö¹ÐÅºÅ */
 227   1          STO = 1;
 228   1          /* ´®ÐÐÖÐ¶Ï±êÖ¾SIÇåÁã ´®ÐÐ´«ÊäÔÝÍ£ */
 229   1          SI = 0;
 230   1      
 231   1          /* ¼ì²âSTOÍ£Ö¹±êÖ¾ Í¨¹ý²âÊÔµÃÖª µÈ´ýÊ±¼äÎªcnnt=0x0e */
 232   1          while ((I2CON & 0x10) == 0x10)
 233   1          {
 234   2              if (++delay_count > 250)
 235   2              {
 236   3                  break;
 237   3              }
 238   2          }
 239   1      }
C51 COMPILER V9.60.0.0   I2C                                                               02/01/2020 20:17:01 PAGE 5   

 240          
 241          /* Ð´¼Ä´æÆ÷µØÖ· */
 242          static void i2c_8563_address(uint8_t sub)
 243          {
 244   1          uint8_t delay_count = 0;
 245   1      
 246   1          /* I2C Êý¾Ý¼Ä´æÆ÷ Ö»ÒªSIÎªÂß¼­1 I2DATÖÐµÄÊý¾Ý±£³Ö²»±ä ÔÚI2C·¢ËÍ½ÓÊÕ¹ý³ÌÖÐ ¶Á»òÐ´I2DATµÄ½á¹û¶¼ÊÇ²»È·¶¨µ
             -Ä */
 247   1          /* XXX Address high for I2C EEPROM */
 248   1          I2DAT = sub;
 249   1          /* ´®ÐÐÖÐ¶Ï±êÖ¾SIÇåÁã ´®ÐÐ´«ÊäÔÝÍ£ */
 250   1          SI = 0;
 251   1      
 252   1          /* ¼ì²â´®ÐÐÖÐ¶Ï±êÖ¾SIÊÇ·ñÖÃÎ» ÖÃÎ»ºóÌø³öÑ­»· Í¨¹ý²âÊÔµÃÖª µÈ´ýÊ±¼äÎªcnnt=0x0e */
 253   1          while (!(I2CON & SET_BIT3))
 254   1          {
 255   2              if (++delay_count > 250)
 256   2              {
 257   3                  break;
 258   3              }
 259   2          }
 260   1      }
 261          
 262          static void i2c_write_data(uint8_t *time, uint8_t length)
 263          {
 264   1          uint8_t *ptemp = time;
 265   1          uint8_t i = 0;
 266   1          uint8_t delay_count;
 267   1      
 268   1          for (i = 0; i < length; i++)
 269   1          {
 270   2              /* I2C Êý¾Ý¼Ä´æÆ÷ Ö»ÒªSIÎªÂß¼­1 I2DATÖÐµÄÊý¾Ý±£³Ö²»±ä ÔÚI2C·¢ËÍ½ÓÊÕ¹ý³ÌÖÐ ¶Á»òÐ´I2DATµÄ½á¹û¶¼ÊÇ²»È
             -·¶¨µÄ */
 271   2              I2DAT = *ptemp;
 272   2              /* ´®ÐÐÖÐ¶Ï±êÖ¾SIÇåÁã ´®ÐÐ´«ÊäÔÝÍ£ */
 273   2              SI = 0;
 274   2      
 275   2              delay_count = 0;
 276   2              /* Í¨¹ý²âÊÔµÃÖª£¬µÈ´ýÊ±¼äÎªcnnt=0x69¡£·´»ã±àµÃÖª£º¸ÃÐÐÓï¾ä¹²7ÌõÖ¸Áî¡£×ÜÖ¸ÁîÊý=735.=33uS@22M */
 277   2              /* ¼ì²â´®ÐÐÖÐ¶Ï±êÖ¾SIÊÇ·ñÖÃÎ» ÖÃÎ»ºóÌø³öÑ­»· Í¨¹ý²âÊÔµÃÖª µÈ´ýÊ±¼äÎªcnnt=0x0e */
 278   2              while (!(I2CON & SET_BIT3))
 279   2              {
 280   3                  if (++delay_count > 250)
 281   3                  {
 282   4                      break;
 283   4                  }
 284   3              }
 285   2      
 286   2              ptemp++;
 287   2          }
 288   1      }
 289          
 290          /* ´ÓI2CÖÐ¶ÁÈ¡¹Ì¶¨³¤¶ÈÊý¾Ý·ÅÈë»º³åÊý×é */
 291          static void i2c_read_data(uint8_t *temp, uint8_t length)
 292          {
 293   1          uint8_t i = 0;
 294   1          uint8_t delay_count;
 295   1      
 296   1          for (i = 0; i < length; i++)
 297   1          {
 298   2              /* I2CON[2] -> AA
 299   2                  - Èç¹ûAA±êÖ¾ÖÃÎ» µ±I2CÉè±¸Îª½ÓÊÕÆ÷Ê± ÔÚÓ¦´ðÊ±ÖÓÂö³åÆÚ¼ä½«·µ»ØACK¡£
C51 COMPILER V9.60.0.0   I2C                                                               02/01/2020 20:17:01 PAGE 6   

 300   2                  - Èç¹ûAA±»ÇåÁã µ±I2CÉè±¸ÊÇ½ÓÊÕÆ÷Ê± ÔÚÓ¦´ðÊ±ÖÓÂö³åÆÚ¼ä½«·µ»ØNACK (SDAÉÏÎª¸ßµçÆ½)
 301   2                  */
 302   2              AA = 1;
 303   2      
 304   2              /* ´®ÐÐÖÐ¶Ï±êÖ¾SIÇåÁã ´®ÐÐ´«ÊäÔÝÍ£ */
 305   2              SI = 0;
 306   2      
 307   2              delay_count = 0;
 308   2              /* ¼ì²â´®ÐÐÖÐ¶Ï±êÖ¾SIÊÇ·ñÖÃÎ» ÖÃÎ»ºóÌø³öÑ­»· Í¨¹ý²âÊÔµÃÖª µÈ´ýÊ±¼äÎªcnnt=0x69 */
 309   2              while (!(I2CON & SET_BIT3))
 310   2              {
 311   3                  if (++delay_count > 250)
 312   3                  {
 313   4                      break;
 314   4                  }
 315   3              }
 316   2              *temp = I2DAT;
 317   2              temp++;
 318   2          }
 319   1      
 320   1          /* I2CON[2] -> AA
 321   1              - Èç¹ûAA±êÖ¾ÖÃÎ» µ±I2CÉè±¸Îª½ÓÊÕÆ÷Ê± ÔÚÓ¦´ðÊ±ÖÓÂö³åÆÚ¼ä½«·µ»ØACK¡£
 322   1              - Èç¹ûAA±»ÇåÁã µ±I2CÉè±¸ÊÇ½ÓÊÕÆ÷Ê± ÔÚÓ¦´ðÊ±ÖÓÂö³åÆÚ¼ä½«·µ»ØNACK (SDAÉÏÎª¸ßµçÆ½)
 323   1              */
 324   1          AA = 0;
 325   1      
 326   1          /* ´®ÐÐÖÐ¶Ï±êÖ¾SIÇåÁã ´®ÐÐ´«ÊäÔÝÍ£ */
 327   1          SI = 0;
 328   1      
 329   1          delay_count = 0;
 330   1          /* ¼ì²â´®ÐÐÖÐ¶Ï±êÖ¾SIÊÇ·ñÖÃÎ» ÖÃÎ»ºóÌø³öÑ­»· Í¨¹ý²âÊÔµÃÖª µÈ´ýÊ±¼äÎªcnnt=0x69 */
 331   1          while (!(I2CON & SET_BIT3))
 332   1          {
 333   2              if (++delay_count > 250)
 334   2              {
 335   3                  break;
 336   3              }
 337   2          }
 338   1      }
 339          
 340          /* ½øÐÐÊý¾Ý×ª»» */
 341          static void i2c_deal_time_code(void)
 342          {
 343   1          /* second */
 344   1          i2c_time_code[0] = i2c_time_code[0] & 0x7f;
 345   1          /* minuter */
 346   1          i2c_time_code[1] = i2c_time_code[1] & 0x7f;
 347   1          /* hour */
 348   1          i2c_time_code[2] = i2c_time_code[2] & 0x3f;
 349   1          /* day */
 350   1          i2c_time_code[3] = i2c_time_code[3] & 0x3f;
 351   1          /* week */
 352   1          i2c_time_code[4] = i2c_time_code[4] & 0x07;
 353   1          /* month */
 354   1          i2c_time_code[5] = i2c_time_code[5] & 0x1f;
 355   1          /* year */
 356   1          i2c_time_code[6] = i2c_time_code[6] & 0xff;
 357   1      }
 358          
 359          /*******************************************************************************
 360           *                 End of File ('EOF')
 361           ******************************************************************************/
C51 COMPILER V9.60.0.0   I2C                                                               02/01/2020 20:17:01 PAGE 7   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    478    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      7       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
